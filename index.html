<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدخال الواجبات الأسبوعية - التجميع المركزي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* التنسيقات الرئيسية */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        :root {
            --primary-color: #2a6e3f;
            --secondary-color: #34a853;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-bg: #f0f7ff;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* الهيدر */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* توجيهات */
        .instructions {
            background: #fff8e1;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-right: 5px solid #f39c12;
        }
        
        .instructions h3 {
            color: #e65100;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-right: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .instructions li {
            margin-bottom: 12px;
            line-height: 1.8;
        }
        
        /* تاريخ الأسبوع */
        .week-dates {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .date-item {
            text-align: center;
            padding: 15px 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            min-width: 200px;
        }
        
        .date-label {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .date-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        /* نموذج الإدخال */
        .input-form {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .section-title {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(42, 110, 63, 0.1);
        }
        
        select.form-control {
            cursor: pointer;
            background: white;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
        
        /* كروت الأيام */
        .day-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-right: 5px solid var(--info-color);
            transition: all 0.3s;
        }
        
        .day-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .day-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .day-date {
            background: var(--info-color);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        /* أزرار التحكم */
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 40px;
        }
        
        .btn {
            padding: 18px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            border: none;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(42, 110, 63, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--info-color) 0%, #2a5298 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(74, 144, 226, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(26, 188, 156, 0.3);
        }
        
        /* رسالة نطاق التواريخ */
        .dates-message {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        
        .dates-message i {
            margin-left: 10px;
            color: var(--secondary-color);
        }
        
        /* التنقل بين الأسابيع */
        .week-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .week-btn {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .week-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* الحالة */
        .status-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-right: 5px solid var(--info-color);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .status-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .icon-saved { background: var(--primary-color); }
        .icon-loaded { background: var(--info-color); }
        .icon-empty { background: var(--warning-color); }
        
        /* الرسائل */
        .message {
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* التحميل */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
        }
        
        .loading i {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .loading p {
            font-size: 1.2rem;
        }
        
        /* الفوتر */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #666;
            border-top: 1px solid var(--border-color);
            font-size: 0.95rem;
        }
        
        /* التجاوب */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .input-form {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .instructions ul {
                grid-template-columns: 1fr;
            }
            
            .week-navigation {
                flex-direction: column;
                align-items: center;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .week-dates {
                flex-direction: column;
                align-items: center;
            }
            
            .date-item {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- الهيدر -->
        <div class="header">
            <h1><i class="fas fa-chalkboard-teacher"></i> نظام إدخال الواجبات الأسبوعية</h1>
            <p>التجميع المركزي - كل معلم يدخل واجبات مادته فقط</p>
        </div>
        
        <!-- التوجيهات -->
        <div class="instructions">
            <h3><i class="fas fa-lightbulb"></i> دليل الاستخدام السريع</h3>
            <ul>
                <li><strong>الخطوة 1:</strong> اختر الصف، الشعبة، والمادة الخاصة بك</li>
                <li><strong>الخطوة 2:</strong> اضغط "تحميل الواجبات" للتحقق من الواجبات الحالية</li>
                <li><strong>الخطوة 3:</strong> أدخل واجبات الأسبوع في الحقول المخصصة</li>
                <li><strong>الخطوة 4:</strong> استخدم "حفظ" لواجبات جديدة أو "تعديل" للتحديث</li>
                <li><strong>ملاحظة:</strong> التواريخ تحفظ تلقائياً حسب الأسبوع الحالي</li>
            </ul>
        </div>
        
        <!-- لوحة الحالة -->
        <div class="status-panel" id="statusPanel" style="display: none;">
            <h3 class="section-title"><i class="fas fa-info-circle"></i> حالة النظام</h3>
            <div id="statusContent"></div>
        </div>
        
        <!-- نموذج الإدخال -->
        <div class="input-form">
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-cog"></i> البيانات الأساسية</h2>
                
                <div class="form-row">
                    <!-- الصف الدراسي -->
                    <div class="form-group">
                        <label for="grade"><i class="fas fa-graduation-cap"></i> الصف الدراسي</label>
                        <select id="grade" class="form-control" required>
                            <option value="">اختر الصف الدراسي</option>
                            <option value="الأول">الصف الأول</option>
                            <option value="الثاني">الصف الثاني</option>
                            <option value="الثالث">الصف الثالث</option>
                            <option value="الرابع">الصف الرابع</option>
                            <option value="الخامس">الصف الخامس</option>
                            <option value="السادس">الصف السادس</option>
                            <option value="السابع">الصف السابع</option>
                            <option value="الثامن">الصف الثامن</option>
                            <option value="التاسع">الصف التاسع</option>
                        </select>
                    </div>
                    
                    <!-- الشعبة -->
                    <div class="form-group">
                        <label for="class"><i class="fas fa-users"></i> الشعبة</label>
                        <select id="class" class="form-control" required>
                            <option value="">اختر الشعبة</option>
                            <option value="أ">الشعبة أ</option>
                            <option value="ب">الشعبة ب</option>
                            <option value="ج">الشعبة ج</option>
                            <option value="د">الشعبة د</option>
                        </select>
                    </div>
                    
                    <!-- المادة الدراسية -->
                    <div class="form-group">
                        <label for="subject"><i class="fas fa-book"></i> المادة الدراسية</label>
                        <select id="subject" class="form-control" required>
                            <option value="">اختر المادة الدراسية</option>
                            <option value="قرآن">قرآن</option>
                            <option value="إسلامية">إسلامية</option>
                            <option value="لغة عربية">لغة عربية</option>
                            <option value="لغة إنجليزية">لغة إنجليزية</option>
                            <option value="رياضيات">رياضيات</option>
                            <option value="علوم">علوم</option>
                            <option value="اجتماعيات">اجتماعيات</option>
                        </select>
                    </div>
                </div>
                
                <!-- اسم المعلم -->
                <div class="form-group" style="max-width: 400px;">
                    <label for="teacher"><i class="fas fa-user"></i> اسم المعلم (اختياري)</label>
                    <input type="text" id="teacher" class="form-control" placeholder="أدخل اسمك للمرجعية">
                </div>
                
                <!-- تاريخ الأسبوع -->
                <div class="week-dates" id="weekDates">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>
                
                <!-- التنقل بين الأسابيع -->
                <div class="week-navigation">
                    <button class="week-btn" onclick="navigateWeek(-1)">
                        <i class="fas fa-chevron-right"></i> الأسبوع السابق
                    </button>
                    <button class="week-btn" onclick="loadCurrentWeek()">
                        <i class="fas fa-sync"></i> تحميل الأسبوع الحالي
                    </button>
                    <button class="week-btn" onclick="navigateWeek(1)">
                        الأسبوع التالي <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>
            
            <!-- واجبات الأيام -->
            <div class="form-section">
                <h2 class="section-title"><i class="fas fa-tasks"></i> واجبات الأسبوع</h2>
                <div id="daysContainer">
                    <!-- سيتم تعبئته بالجافاسكريبت -->
                </div>
            </div>
            
            <!-- التحميل -->
            <div class="loading" id="formLoading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>جاري معالجة البيانات...</p>
            </div>
            
            <!-- الرسائل -->
            <div id="message" class="message"></div>
            
            <!-- أزرار التحكم -->
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="loadHomework()">
                    <i class="fas fa-search"></i> تحميل الواجبات
                </button>
                
                <button class="btn btn-success" onclick="saveHomework()">
                    <i class="fas fa-save"></i> حفظ الواجبات
                </button>
                
                <button class="btn btn-warning" onclick="updateHomework()">
                    <i class="fas fa-edit"></i> تعديل الواجبات
                </button>
                
                <button class="btn btn-danger" onclick="deleteHomework()">
                    <i class="fas fa-trash-alt"></i> حذف الواجبات
                </button>
                
                <button class="btn btn-primary" onclick="clearForm()">
                    <i class="fas fa-broom"></i> تفريغ النموذج
                </button>
            </div>
        </div>
        
        <!-- الفوتر -->
        <div class="footer">
            <p>نظام الواجبات الأسبوعية &copy; 2023 | إصدار 3.0 - التجميع المركزي</p>
            <p style="font-size: 0.9rem; margin-top: 10px; color: #888;">
                تم ربط النظام مع Google Sheets | كل معلم يدخل واجبات مادته فقط
            </p>
        </div>
    </div>
    
    <!-- السكربت -->
    <script>
        // رابط النشر المباشر الذي أرسلته
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzxfDa_YRfstyA1fzpqRHTpimzVeA698Bx_cXXe6xz4i3W19ke8mshfx6ndstqkr5go/exec';
        
        // متغيرات عامة
        let currentWeekStart = null; // تاريخ بداية الأسبوع الحالي (السبت)
        let currentWeekEnd = null;   // تاريخ نهاية الأسبوع الحالي (الأربعاء)
        
        // أيام الأسبوع
        const daysOfWeek = [
            { id: 'السبت', icon: 'fas fa-calendar-day', color: '#3498db' },
            { id: 'الأحد', icon: 'fas fa-sun', color: '#f39c12' },
            { id: 'الإثنين', icon: 'fas fa-moon', color: '#9b59b6' },
            { id: 'الثلاثاء', icon: 'fas fa-star', color: '#e74c3c' },
            { id: 'الأربعاء', icon: 'fas fa-cloud', color: '#1abc9c' }
        ];
        
        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // حساب الأسبوع الحالي (السبت الحالي)
            calculateCurrentWeek();
            
            // عرض تواريخ الأسبوع
            renderWeekDates();
            
            // عرض أيام الأسبوع
            renderDays();
            
            // مستمعات الأحداث للتحديث التلقائي
            document.getElementById('grade').addEventListener('change', updateStatus);
            document.getElementById('class').addEventListener('change', updateStatus);
            document.getElementById('subject').addEventListener('change', updateStatus);
            
            // تحميل الواجبات عند تغيير الأسبوع
            document.getElementById('grade').addEventListener('change', autoLoadIfComplete);
            document.getElementById('class').addEventListener('change', autoLoadIfComplete);
            document.getElementById('subject').addEventListener('change', autoLoadIfComplete);
        });
        
        // حساب الأسبوع الحالي (من السبت إلى الأربعاء)
        function calculateCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = الأحد, 1 = الإثنين, ..., 6 = السبت
            
            // حساب تاريخ السبت الماضي (السبت = 6 في JavaScript)
            const daysSinceSaturday = (dayOfWeek + 1) % 7; // +1 لأن الأحد = 0، السبت = 6
            const lastSaturday = new Date(today);
            lastSaturday.setDate(today.getDate() - daysSinceSaturday);
            
            currentWeekStart = new Date(lastSaturday);
            currentWeekEnd = new Date(lastSaturday);
            currentWeekEnd.setDate(lastSaturday.getDate() + 4); // الأربعاء بعد 4 أيام من السبت
        }
        
        // عرض تواريخ الأسبوع
        function renderWeekDates() {
            if (!currentWeekStart || !currentWeekEnd) return;
            
            const container = document.getElementById('weekDates');
            
            const startDateStr = formatDate(currentWeekStart);
            const endDateStr = formatDate(currentWeekEnd);
            
            container.innerHTML = `
                <div class="date-item">
                    <div class="date-label">بداية الأسبوع (السبت)</div>
                    <div class="date-value">${startDateStr}</div>
                </div>
                <div class="date-item">
                    <div class="date-label">نهاية الأسبوع (الأربعاء)</div>
                    <div class="date-value">${endDateStr}</div>
                </div>
            `;
        }
        
        // تنسيق التاريخ إلى DD/MM/YYYY
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // تحويل التاريخ إلى تنسيق YYYY-MM-DD (للمقارنات)
        function formatDateForComparison(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // عرض أيام الأسبوع
        function renderDays() {
            if (!currentWeekStart) return;
            
            const dates = calculateWeekDates(currentWeekStart);
            const container = document.getElementById('daysContainer');
            
            let html = '';
            
            daysOfWeek.forEach((day, index) => {
                html += `
                    <div class="day-card">
                        <div class="day-header">
                            <div class="day-title">
                                <i class="${day.icon}" style="color: ${day.color}"></i>
                                ${day.id}
                            </div>
                            <div class="day-date">${dates[index]}</div>
                        </div>
                        <div class="form-group">
                            <label for="homework_${day.id}"><i class="fas fa-tasks"></i> الواجب</label>
                            <textarea 
                                id="homework_${day.id}" 
                                class="form-control" 
                                rows="4" 
                                placeholder="أدخل واجب ${day.id} هنا... (اتركه فارغاً إذا لم يكن هناك واجب)"
                            ></textarea>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // حساب تواريخ الأسبوع لعرضها
        function calculateWeekDates(startDate) {
            const dates = [];
            
            for (let i = 0; i < 5; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const formattedDate = currentDate.toLocaleDateString('ar-EG', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                dates.push(formattedDate);
            }
            
            return dates;
        }
        
        // ============ دوال التفاعل مع Apps Script ============
        
        // تحميل الواجبات الحالية
        function loadHomework() {
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (!grade || !className || !subject) {
                showMessage('الرجاء اختيار الصف والشعبة والمادة أولاً', 'error');
                return;
            }
            
            showLoading(true);
            
            const params = new URLSearchParams({
                action: 'getHomework',
                grade: grade,
                class: className,
                subject: subject,
                startDate: formatDate(currentWeekStart),
                endDate: formatDate(currentWeekEnd)
            });
            
            fetch(`${APPS_SCRIPT_URL}?${params.toString()}`)
                .then(response => response.json())
                .then(result => {
                    showLoading(false);
                    
                    if (result.error) {
                        showMessage(result.error, 'error');
                        return;
                    }
                    
                    if (result.exists) {
                        // ملء الحقول بالبيانات الموجودة
                        daysOfWeek.forEach(day => {
                            const fieldId = `homework_${day.id}`;
                            const textarea = document.getElementById(fieldId);
                            if (textarea) {
                                const dayKey = day.id.toLowerCase();
                                textarea.value = result.homework[dayKey] || '';
                            }
                        });
                        
                        showMessage('تم تحميل الواجبات الحالية', 'success');
                    } else {
                        showMessage('لا توجد واجبات مسجلة لهذا الأسبوع. يمكنك إدخال واجبات جديدة.', 'info');
                        // إفراغ الحقول للبدء من جديد
                        clearHomeworkFields();
                    }
                    
                    updateStatus();
                })
                .catch(error => {
                    showLoading(false);
                    showMessage('حدث خطأ في تحميل الواجبات: ' + error.message, 'error');
                });
        }
        
        // حفظ واجبات جديدة
        function saveHomework() {
            const homeworkData = collectHomeworkData();
            if (!homeworkData) return;
            
            showLoading(true);
            
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveHomework',
                    ...homeworkData
                })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                
                if (result.success) {
                    showMessage(result.message + ' (تم الحفظ في: ' + result.timestamp + ')', 'success');
                    updateStatus();
                } else {
                    showMessage(result.error || 'حدث خطأ في الحفظ', 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showMessage('حدث خطأ في الاتصال: ' + error.message, 'error');
            });
        }
        
        // تعديل واجبات موجودة
        function updateHomework() {
            const homeworkData = collectHomeworkData();
            if (!homeworkData) return;
            
            showLoading(true);
            
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'updateHomework',
                    ...homeworkData
                })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                
                if (result.success) {
                    showMessage(result.message + ' (تم التحديث في: ' + result.timestamp + ')', 'success');
                    updateStatus();
                } else {
                    showMessage(result.error || 'حدث خطأ في التعديل', 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showMessage('حدث خطأ في الاتصال: ' + error.message, 'error');
            });
        }
        
        // حذف واجبات
        function deleteHomework() {
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (!grade || !className || !subject) {
                showMessage('الرجاء اختيار الصف والشعبة والمادة أولاً', 'error');
                return;
            }
            
            if (!confirm('⚠️ هل أنت متأكد من حذف واجبات هذا الأسبوع؟\n\nهذا الإجراء سيحذف جميع الواجبات ولا يمكن التراجع عنه.')) {
                return;
            }
            
            showLoading(true);
            
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'deleteHomework',
                    grade: grade,
                    class: className,
                    subject: subject,
                    startDate: formatDate(currentWeekStart),
                    endDate: formatDate(currentWeekEnd)
                })
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    clearHomeworkFields();
                    updateStatus();
                } else {
                    showMessage(result.error || 'حدث خطأ في الحذف', 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                showMessage('حدث خطأ في الاتصال: ' + error.message, 'error');
            });
        }
        
        // جمع بيانات الواجبات من النموذج
        function collectHomeworkData() {
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            const teacher = document.getElementById('teacher').value;
            
            if (!grade || !className || !subject) {
                showMessage('الرجاء اختيار الصف والشعبة والمادة أولاً', 'error');
                return null;
            }
            
            const homeworkData = {
                grade: grade,
                class: className,
                subject: subject,
                saturday: document.getElementById('homework_السبت')?.value || '',
                sunday: document.getElementById('homework_الأحد')?.value || '',
                monday: document.getElementById('homework_الإثنين')?.value || '',
                tuesday: document.getElementById('homework_الثلاثاء')?.value || '',
                wednesday: document.getElementById('homework_الأربعاء')?.value || '',
                startDate: formatDate(currentWeekStart),
                endDate: formatDate(currentWeekEnd)
            };
            
            if (teacher) {
                homeworkData.teacher = teacher;
            }
            
            return homeworkData;
        }
        
        // التنقل بين الأسابيع
        function navigateWeek(direction) {
            if (!currentWeekStart || !currentWeekEnd) return;
            
            currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
            currentWeekEnd.setDate(currentWeekEnd.getDate() + (direction * 7));
            
            renderWeekDates();
            renderDays();
            
            // تحميل الواجبات تلقائياً إذا كان هناك صف وشعبة ومادة محددين
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (grade && className && subject) {
                setTimeout(loadHomework, 300);
            } else {
                clearHomeworkFields();
            }
            
            showMessage(`تم التحميل للأسبوع: ${formatDate(currentWeekStart)} - ${formatDate(currentWeekEnd)}`, 'info');
        }
        
        // تحميل الأسبوع الحالي
        function loadCurrentWeek() {
            calculateCurrentWeek();
            renderWeekDates();
            renderDays();
            
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (grade && className && subject) {
                setTimeout(loadHomework, 300);
            } else {
                clearHomeworkFields();
            }
            
            showMessage('تم تحميل الأسبوع الحالي', 'info');
        }
        
        // التحميل التلقائي عند اكتمال البيانات
        function autoLoadIfComplete() {
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (grade && className && subject) {
                setTimeout(loadHomework, 500);
            }
        }
        
        // تفريغ النموذج
        function clearForm() {
            document.getElementById('grade').value = '';
            document.getElementById('class').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('teacher').value = '';
            
            clearHomeworkFields();
            updateStatus();
            
            showMessage('تم تفريغ النموذج، يمكنك البدء بإدخال جديد', 'info');
        }
        
        // إفراغ حقول الواجبات
        function clearHomeworkFields() {
            daysOfWeek.forEach(day => {
                const textarea = document.getElementById(`homework_${day.id}`);
                if (textarea) textarea.value = '';
            });
        }
        
        // تحديث لوحة الحالة
        function updateStatus() {
            const grade = document.getElementById('grade').value;
            const className = document.getElementById('class').value;
            const subject = document.getElementById('subject').value;
            
            if (!grade || !className || !subject) {
                document.getElementById('statusPanel').style.display = 'none';
                return;
            }
            
            // حساب الأيام التي بها واجب
            let homeworkCount = 0;
            let totalChars = 0;
            
            daysOfWeek.forEach(day => {
                const textarea = document.getElementById(`homework_${day.id}`);
                if (textarea && textarea.value.trim() !== '') {
                    homeworkCount++;
                    totalChars += textarea.value.length;
                }
            });
            
            const statusHTML = `
                <div class="status-item">
                    <div class="status-icon icon-loaded">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                    <div>
                        <strong>الأسبوع:</strong> ${formatDate(currentWeekStart)} → ${formatDate(currentWeekEnd)}
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-icon icon-saved">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <strong>الصف:</strong> ${grade} | <strong>الشعبة:</strong> ${className} | <strong>المادة:</strong> ${subject}
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-icon ${homeworkCount > 0 ? 'icon-saved' : 'icon-empty'}">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div>
                        <strong>الواجبات المدخلة:</strong> ${homeworkCount} من 5 أيام (${totalChars} حرف)
                    </div>
                </div>
            `;
            
            document.getElementById('statusContent').innerHTML = statusHTML;
            document.getElementById('statusPanel').style.display = 'block';
        }
        
        // عرض الرسائل
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        // عرض/إخفاء التحميل
        function showLoading(show) {
            document.getElementById('formLoading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>